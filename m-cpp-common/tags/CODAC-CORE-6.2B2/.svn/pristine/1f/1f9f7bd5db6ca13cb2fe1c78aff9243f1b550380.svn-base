#+======================================================================
# $HeadURL$
# $Id$
#
# Project       : CODAC Core System
#
# Description   : C++ Makefile
#
# Author        : This file was generated by CODAC development toolkit
#
# Copyright (c) : 2010-2019 ITER Organization,
#                 CS 90 046
#                 13067 St. Paul-lez-Durance Cedex
#                 France
#
# This file is part of ITER CODAC software.
# For the terms and conditions of redistribution or use of this software
# refer to the file ITER-LICENSE.TXT located in the top level directory
# of the distribution package.
#
#-======================================================================

LIBNAME=ccs-core

#LIBVERSION=1.1.0
LIBVERSION=$(shell grep '<version>1' ../../../../pom.xml | sed 's/    <version>//g' | sed 's/<\/version>//g')
LIBMAJOR=$(shell echo $(LIBVERSION) | sed 's/\([1-9]\).\([0-9]\).\([0-9]\)/\1/g')
LIBMINOR=$(shell echo $(LIBVERSION) | sed 's/\([1-9]\).\([0-9]\).\([0-9]\)/\2/g')
LIBMAINT=$(shell echo $(LIBVERSION) | sed 's/\([1-9]\).\([0-9]\).\([0-9]\)/\3/g')

SONAME=lib$(LIBNAME).so.$(LIBMAJOR)
REALNAME=lib$(LIBNAME).so.$(LIBVERSION)

LIBRARIES := rt pthread
LIBRARY_DIRS := 
INCLUDE_DIRS := . ../include ../common ../types ../base ../tools

ifdef CODAC_ROOT
LIBRARY_DIRS += $(CODAC_ROOT)/lib
INCLUDE_DIRS += $(CODAC_ROOT)/include
endif

TARGET=../../../../target

SRC_DIR := .
BIN_DIR := $(TARGET)/bin
LIB_DIR := $(TARGET)/lib
## Bug 10805 - Coverage report handled through MVN
#OBJ_DIR := $(TARGET)/obj
OBJ_DIR := $(SRC_DIR)/.obj
#COV_DIR := $(TARGET)/cov/library

INCLUDES=$(foreach inc,$(INCLUDE_DIRS),-I$(inc))

ifdef CODAC_ROOT
LDLIBS=$(foreach libs,$(LIBRARY_DIRS),-L$(libs) -Wl,-rpath,$(libs)) $(foreach libs,$(LIBRARIES),-l$(libs))
else
LDLIBS=$(foreach libs,$(LIBRARY_DIRS),-L$(libs) -Wl,--no-as-needed) $(foreach libs,$(LIBRARIES),-l$(libs)) -pthread
endif

SOURCES := $(wildcard $(SRC_DIR)/*.cpp $(SRC_DIR)/*.c)

#COVOBJS := $(addprefix $(COV_DIR)/,$(patsubst %.cpp,%.cov,$(notdir $(SOURCES))))
OBJECTS := $(addprefix $(OBJ_DIR)/,$(patsubst %.cpp,%.obj,$(notdir $(SOURCES))))
OBJECTS += $(wildcard $(TARGET)/main/c++/base/.obj/*.obj)
OBJECTS += $(wildcard $(TARGET)/main/c++/common/.obj/*.obj)
OBJECTS += $(wildcard $(TARGET)/main/c++/types/.obj/*.obj)

GPP=g++

OPTIONS := -fPIC -c -std=c++11
OPTIONS += -pedantic -Wall -Werror -Wextra
## Temporary
## ToDo - Fix log-api.h
OPTIONS += -Wno-variadic-macros
OPTIONS += -DUNIT_VERSION=$(shell echo "$(LIBMAJOR) * 100 + $(LIBMINOR) * 10 + $(LIBMAINT)" | bc -l)
OPTIONS += -DUNIT_VERSION_HR=\"$(LIBVERSION)\"
OPTIONS += -DBUILD_DATE=\"$(shell date +'%FT%H:%M')\"
OPTIONS += -DBUILD_USER=\"$(shell whoami)\"
ifdef CODAC_ROOT
#OPTIONS += -DSVN_REVISION=\"$(shell svnversion -c -n ../../../.. | sed 's/[0-9]*://g')\"
endif

## Bug 10805 - Coverage report handled through MVN
ifeq ($(COVERAGE),true)
OPTIONS += -DDEBUG -O0 -g -fprofile-arcs -ftest-coverage --coverage
endif

LDFLAGS :=

clean:
	@rm -rf ./*~ ./include/*~ 
	@rm -rf $(COV_DIR) $(OBJ_DIR) $(LIB_DIR)/lib$(LIBNAME)*

all: $(SOURCES) $(OBJECTS) libs

#coverage: $(COVOBJS)

libs: staticlib dynamiclib

staticlib: $(OBJECTS)
	@mkdir -p $(LIB_DIR)
	$(AR) $(ARFLAGS) $(LIB_DIR)/lib$(LIBNAME).a $^

dynamiclib: $(OBJECTS)
	@mkdir -p $(LIB_DIR)
	$(GPP) -shared $(LDFLAGS) $(LDLIBS) -Wl,-soname,$(SONAME) -o $(LIB_DIR)/$(REALNAME) $^
	ln -sf $(REALNAME) $(LIB_DIR)/lib$(LIBNAME).so
	ln -sf $(REALNAME) $(LIB_DIR)/lib$(LIBNAME).so.$(LIBMAJOR)

$(COV_DIR)/%.cov: $(SRC_DIR)/%.cpp
	@mkdir -p $(COV_DIR)
	$(GPP) $(OPTIONS) -g -fprofile-arcs -ftest-coverage --coverage $(INCLUDES) $< -o $@

$(OBJ_DIR)/%.obj: $(SRC_DIR)/%.cpp
	@mkdir -p $(OBJ_DIR)
	$(GPP) $(OPTIONS) $(INCLUDES) $< -o $@
