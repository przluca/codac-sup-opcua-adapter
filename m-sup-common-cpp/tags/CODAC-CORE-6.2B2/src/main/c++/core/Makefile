#+======================================================================
# $HeadURL: https://svnpub.iter.org/codac/iter/codac/dev/units/m-sup-common-cpp/tags/CODAC-CORE-6.2B2/src/main/c++/core/Makefile $
# $Id: Makefile 101436 2019-08-07 17:09:04Z bauvirb $
#
# Project       : CODAC Core System
#
# Description   : C++ Makefile
#
# Author        : This file was generated by CODAC development toolkit
#
# Copyright (c) : 2010-2019 ITER Organization,
#                 CS 90 046
#                 13067 St. Paul-lez-Durance Cedex
#                 France
#
# This file is part of ITER CODAC software.
# For the terms and conditions of redistribution or use of this software
# refer to the file ITER-LICENSE.TXT located in the top level directory
# of the distribution package.
#
#-======================================================================

LIBNAME=sup-core

#LIBVERSION=1.1.0
LIBVERSION=$(shell grep '<version>1' ../../../../pom.xml | sed 's/    <version>//g' | sed 's/<\/version>//g')
LIBMAJOR=$(shell echo $(LIBVERSION) | sed 's/\([1-9]\).\([0-9]\).\([0-9]\)/\1/g')
LIBMINOR=$(shell echo $(LIBVERSION) | sed 's/\([1-9]\).\([0-9]\).\([0-9]\)/\2/g')
LIBMAINT=$(shell echo $(LIBVERSION) | sed 's/\([1-9]\).\([0-9]\).\([0-9]\)/\3/g')

SONAME=lib$(LIBNAME).so.$(LIBMAJOR)
REALNAME=lib$(LIBNAME).so.$(LIBVERSION)

LIBRARIES := rt pthread dl
LIBRARIES += ccs-core
LIBRARIES += sdn-core ## SUP multicast messenger

LIBRARY_DIRS := 

INCLUDE_DIRS := .

ifdef CODAC_ROOT
LIBRARY_DIRS += $(CODAC_ROOT)/lib
#INCLUDE_DIRS += $(CODAC_ROOT)/include
INCLUDE_DIRS += $(CODAC_ROOT)/m-cpp-common/tags/CODAC-CORE-6.2B2/src/main/c++/base
INCLUDE_DIRS += $(CODAC_ROOT)/m-cpp-common/tags/CODAC-CORE-6.2B2/src/main/c++/include
INCLUDE_DIRS += $(CODAC_ROOT)/m-cpp-common/tags/CODAC-CORE-6.2B2/src/main/c++/types
INCLUDE_DIRS += $(CODAC_ROOT)/m-cpp-common/tags/CODAC-CORE-6.2B2/src/main/c++/tools
INCLUDE_DIRS += $(CODAC_ROOT)/m-cpp-common/tags/CODAC-CORE-6.2B2/src/main/c++/common
INCLUDE_DIRS += $(CODAC_ROOT)/m-cpp-tools/tags/CODAC-CORE-6.2B2/src/main/c++/ca/
INCLUDE_DIRS += $(CODAC_ROOT)/m-cpp-tools/tags/CODAC-CORE-6.2B2/src/main/c++/pva/
INCLUDE_DIRS += $(CODAC_ROOT)/m-cpp-tools/tags/CODAC-CORE-6.2B2/src/main/c++/opcua/
INCLUDE_DIRS += $(CODAC_ROOT)/m-sdn-core/tags/CODAC-CORE-6.2B2/src/main/c++/include
endif

TARGET=$(CODAC_ROOT)

SRC_DIR := .
BIN_DIR := $(TARGET)/bin
LIB_DIR := $(TARGET)/lib
## Bug 10805 - Coverage report handled through MVN
#OBJ_DIR := $(TARGET)/obj
OBJ_DIR := $(SRC_DIR)/.obj

INCLUDES=$(foreach inc,$(INCLUDE_DIRS),-I$(inc))

ifdef CODAC_ROOT
LDLIBS=$(foreach libs,$(LIBRARY_DIRS),-L$(libs) -Wl,-rpath,$(libs)) $(foreach libs,$(LIBRARIES),-l$(libs))
else
LDLIBS=$(foreach libs,$(LIBRARY_DIRS),-L$(libs) -Wl,--no-as-needed) $(foreach libs,$(LIBRARIES),-l$(libs)) -pthread
endif

SOURCES := $(wildcard $(SRC_DIR)/*.cpp $(SRC_DIR)/*.c)
OBJECTS := $(addprefix $(OBJ_DIR)/,$(patsubst %.cpp,%.obj,$(notdir $(SOURCES))))

GPP=g++

OPTIONS := -fPIC -c -std=c++11
#OPTIONS += -pedantic -Wall -Werror -Wextra
OPTIONS += -Wall
## Temporary
## ToDo - Fix log-api.h
OPTIONS += -Wno-variadic-macros
## ToDo - any-type.cpp
OPTIONS += -Wno-format
OPTIONS += -DUNIT_VERSION=$(shell echo "$(LIBMAJOR) * 100 + $(LIBMINOR) * 10 + $(LIBMAINT)" | bc -l)
OPTIONS += -DUNIT_VERSION_HR=\"$(LIBVERSION)\"
OPTIONS += -DBUILD_DATE=\"$(shell date +'%FT%H:%M')\"
OPTIONS += -DBUILD_USER=\"$(shell whoami)\"

LDFLAGS :=

## Bug 10805 - Coverage report handled through MVN
ifeq ($(COVERAGE),true)
OPTIONS += -DDEBUG -O0 -g -fprofile-arcs -ftest-coverage --coverage
LDFLAGS += --coverage
endif

clean:
	@rm -rf ./*~ ./include/*~ 
	@rm -rf $(COV_DIR) $(OBJ_DIR) $(LIB_DIR)/lib$(LIBNAME)*

all: $(SOURCES) $(OBJECTS) libs

libs: staticlib dynamiclib

staticlib: $(OBJECTS) 
	@mkdir -p $(LIB_DIR)
	$(AR) $(ARFLAGS) $(LIB_DIR)/lib$(LIBNAME).a $^

dynamiclib: $(OBJECTS) 
	@mkdir -p $(LIB_DIR)
	$(GPP) -shared $(LDFLAGS) $(LDLIBS) -Wl,-soname,$(SONAME) -o $(LIB_DIR)/$(REALNAME) $^
	ln -sf $(REALNAME) $(LIB_DIR)/lib$(LIBNAME).so
	ln -sf $(REALNAME) $(LIB_DIR)/lib$(LIBNAME).so.$(LIBMAJOR)

$(OBJ_DIR)/%.obj: $(SRC_DIR)/%.cpp
	@mkdir -p $(OBJ_DIR)
	$(GPP) $(OPTIONS) $(INCLUDES) $< -o $@
