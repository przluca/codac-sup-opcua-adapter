#+======================================================================
# $HeadURL: https://svnpub.codac.iter.org/codac/iter/codac/dev/units/m-sup-common-cpp/trunk/src/main/c++/cvvf/Makefile $
# $Id: Makefile 98343 2019-03-10 12:50:23Z bauvirb $
#
# Project       : CODAC Core System
#
# Description   : C++ Makefile
#
# Author        : This file was generated by CODAC development toolkit
#
# Copyright (c) : 2010-2019 ITER Organization,
#                 CS 90 046
#                 13067 St. Paul-lez-Durance Cedex
#                 France
#
# This file is part of ITER CODAC software.
# For the terms and conditions of redistribution or use of this software
# refer to the file ITER-LICENSE.TXT located in the top level directory
# of the distribution package.
#
#-======================================================================

LIBNAME=55a0-config

#LIBVERSION=1.1.0
LIBVERSION=$(shell grep '<version>1' ../../../../pom.xml | sed 's/    <version>//g' | sed 's/<\/version>//g')
LIBMAJOR=$(shell echo $(LIBVERSION) | sed 's/\([1-9]\).\([0-9]\).\([0-9]\)/\1/g')
LIBMINOR=$(shell echo $(LIBVERSION) | sed 's/\([1-9]\).\([0-9]\).\([0-9]\)/\2/g')
LIBMAINT=$(shell echo $(LIBVERSION) | sed 's/\([1-9]\).\([0-9]\).\([0-9]\)/\3/g')

SONAME=lib$(LIBNAME).so.$(LIBMAJOR)
REALNAME=lib$(LIBNAME).so.$(LIBVERSION)

LIBRARIES := rt pthread
LIBRARIES += sdn-core
LIBRARIES += sup-config

LIBRARY_DIRS := $(CODAC_ROOT)/lib
LIBRARY_DIRS += ../../../../target/lib

INCLUDE_DIRS := .
#INCLUDE_DIRS += ../../../main/c++/config
#INCLUDE_DIRS += $(CODAC_ROOT)/include
INCLUDE_DIRS += $(CODAC_ROOT)/m-cpp-common/tags/CODAC-CORE-6.2B2/src/main/c++/base
INCLUDE_DIRS += $(CODAC_ROOT)/m-cpp-common/tags/CODAC-CORE-6.2B2/src/main/c++/include
INCLUDE_DIRS += $(CODAC_ROOT)/m-cpp-common/tags/CODAC-CORE-6.2B2/src/main/c++/types
INCLUDE_DIRS += $(CODAC_ROOT)/m-cpp-common/tags/CODAC-CORE-6.2B2/src/main/c++/tools
INCLUDE_DIRS += $(CODAC_ROOT)/m-cpp-common/tags/CODAC-CORE-6.2B2/src/main/c++/common
INCLUDE_DIRS += $(CODAC_ROOT)/m-cpp-tools/tags/CODAC-CORE-6.2B2/src/main/c++/ca/
INCLUDE_DIRS += $(CODAC_ROOT)/m-cpp-tools/tags/CODAC-CORE-6.2B2/src/main/c++/pva/
INCLUDE_DIRS += $(CODAC_ROOT)/m-cpp-tools/tags/CODAC-CORE-6.2B2/src/main/c++/opcua/
INCLUDE_DIRS += $(CODAC_ROOT)/m-sdn-core/tags/CODAC-CORE-6.2B2/src/main/c++/include
INCLUDE_DIRS += $(CODAC_ROOT)/m-sup-common-cpp/tags/CODAC-CORE-6.2B2/src/main/c++/config
INCLUDE_DIRS += $(MARTe2_DIR)/Source

TARGET=../../../../target

BIN_DIR := $(TARGET)/bin
LIB_DIR := $(TARGET)/lib
OBJ_DIR := $(TARGET)/obj
COV_DIR := $(TARGET)/cov/library
SRC_DIR := .

INCLUDES=$(foreach inc,$(INCLUDE_DIRS),-I$(inc))
LDLIBS=$(foreach libs,$(LIBRARY_DIRS),-L$(libs) -Wl,-rpath,$(libs)) $(foreach libs,$(LIBRARIES),-l$(libs))

SOURCES=$(wildcard $(SRC_DIR)/*.cpp $(SRC_DIR)/*.c)
OBJECTS=$(addprefix $(OBJ_DIR)/,$(patsubst %.cpp,%.obj,$(notdir $(SOURCES))))

GPP=g++

OPTIONS := -fPIC -c -std=c++11
OPTIONS += -Wall
## Temporary
## ToDo - Fix log-api.h
OPTIONS += -Wno-variadic-macros
## ToDo - any-type.cpp
OPTIONS += -Wno-format
OPTIONS += -DUNIT_VERSION_HR=\"$(LIBVERSION)\"
##OPTIONS += -DSVN_REVISION=\"$(shell svnversion -c -n ../../../.. | sed 's/[0-9]*://g')\"
OPTIONS += -DBUILD_DATE=\"$(shell date +'%FT%H:%M')\"
OPTIONS += -DBUILD_USER=\"$(shell whoami)\"
OPTIONS += -DARCHITECTURE=x86_gcc

LDFLAGS :=

all: $(SOURCES) $(OBJECTS) libs

clean:
	@rm -rf ./*~ ./include/*~ 
	@rm -rf $(OBJ_DIR) $(LIB_DIR)/lib$(LIBNAME)*

libs: staticlib dynamiclib

staticlib: $(OBJECTS) 
	@mkdir -p $(LIB_DIR)
	$(AR) $(ARFLAGS) $(LIB_DIR)/lib$(LIBNAME).a $^

dynamiclib: $(OBJECTS) 
	@mkdir -p $(LIB_DIR)
	$(GPP) -shared $(LDFLAGS) $(LDLIBS) -Wl,-soname,$(SONAME) -o $(LIB_DIR)/$(REALNAME) $^
	ln -sf $(REALNAME) $(LIB_DIR)/lib$(LIBNAME).so
	ln -sf $(REALNAME) $(LIB_DIR)/lib$(LIBNAME).so.$(LIBMAJOR)

$(OBJ_DIR)/%.obj: $(SRC_DIR)/%.cpp
	@mkdir -p $(OBJ_DIR)
	$(GPP) $(OPTIONS) $(INCLUDES) $< -o $@
